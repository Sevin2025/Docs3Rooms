<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3D-галерея Sergeywieden</title>
<style>
html, body { margin: 0; height: 100%; overflow: hidden; font-family: Arial, sans-serif; }
canvas { display: block; }
#overlayUI {
  position: fixed; top: 12px; right: 12px; z-index: 20;
  background: rgba(255,255,255,0.95); padding: 8px;
  border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); max-width: 320px;
}
#descriptionBox {
  position: fixed; left: 12px; bottom: 12px; z-index: 30;
  background: rgba(0,0,0,0.85); color: #fff; padding: 12px;
  border-radius: 6px; max-width: 40%; display: none;
}
#descTitle { font-weight: 700; margin-bottom: 6px; }
#enterHint {
  position: fixed; left: 50%; bottom: 40px; transform: translateX(-50%);
  z-index: 25; background: rgba(0,0,0,0.6); color: #fff;
  padding: 8px 12px; border-radius: 20px;
}
</style>
</head>
<body>

<div id="overlayUI">
  <div><strong>3D-галерея</strong></div>
  <div style="font-size:13px;margin-top:6px">
    Управление: WASD + мышь. Клик на картину — описание.
  </div>
  <div style="margin-top:8px">
    <label><input id="showLabels" type="checkbox" checked/> Показывать подписи</label>
  </div>
  <div style="margin-top:6px">
    <button id="resetPos">Сброс позиции</button>
  </div>
  <div style="margin-top:6px">
    <label>Режим:
      <select id="moveMode">
        <option value="fp">1st-person</option>
        <option value="orbit">Orbit</option>
      </select>
    </label>
  </div>
  <div style="margin-top:6px;font-size:12px;color:#666">Загрузка: <span id="loadStatus">0%</span></div>
</div>

<div id="descriptionBox"><div id="descTitle"></div><div id="descText" style="white-space:pre-wrap"></div></div>
<div id="enterHint">Клик по сцене, чтобы начать (Pointer Lock). ESC — выйти.</div>

<script type="module">
import * as THREE from './assets/three/three.module.js';
import { PointerLockControls } from './assets/three/PointerLockControls.js';
import { OrbitControls } from './assets/three/OrbitControls.js';

let scene, camera, renderer;
let controlsFP, controlsOrbit, currentControls;
let raycaster = new THREE.Raycaster();
let mouse = new THREE.Vector2();
let paintingsGroup = new THREE.Group();
let INTERSECTED = null;

init();
animate();

function init() {
  // Сцена и камера
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0xdddddd);
  camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(0,1.6,5);

  // Рендерер
  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.outputEncoding = THREE.sRGBEncoding;
  document.body.appendChild(renderer.domElement);

  // Свет
  scene.add(new THREE.AmbientLight(0xffffff, 0.6));
  const dir = new THREE.DirectionalLight(0xffffff, 0.6);
  dir.position.set(5,10,5);
  scene.add(dir);

  // Контролы
  controlsFP = new PointerLockControls(camera, renderer.domElement);
  controlsOrbit = new OrbitControls(camera, renderer.domElement);
  controlsOrbit.enabled = false;
  currentControls = controlsFP;

  renderer.domElement.addEventListener('click', ()=> controlsFP.lock());

  // Простая комната
  const room = new THREE.Mesh(
    new THREE.BoxGeometry(12,4,12),
    new THREE.MeshStandardMaterial({color:0xeeeeee, side:THREE.BackSide})
  );
  scene.add(room);

  // Пример картины
  const texLoader = new THREE.TextureLoader();
  const paintingTex = texLoader.load('./assets/painting.jpg');
  const plane = new THREE.Mesh(
    new THREE.PlaneGeometry(2,2),
    new THREE.MeshStandardMaterial({map: paintingTex})
  );
  plane.position.set(0,1.5,-5);
  paintingsGroup.add(plane);
  scene.add(paintingsGroup);

  // События
  window.addEventListener('resize', onResize);
  document.addEventListener('mousemove', onMouseMove);
  document.addEventListener('click', onClick);
}

function onResize(){
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

function onMouseMove(event){
  mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
  mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
}

function onClick(){
  raycaster.setFromCamera(mouse, camera);
  const intersects = raycaster.intersectObjects(paintingsGroup.children);
  if(intersects.length>0){
    const painting = intersects[0].object;
    document.getElementById('descriptionBox').style.display='block';
    document.getElementById('descTitle').innerText='Картина';
    document.getElementById('descText').innerText='Описание картины...';
  }
}

function animate(){
  requestAnimationFrame(animate);
  // Подсветка картин
  raycaster.setFromCamera(mouse, camera);
  const intersects = raycaster.intersectObjects(paintingsGroup.children);
  if(intersects.length>0){
    if(INTERSECTED != intersects[0].object){
      INTERSECTED = intersects[0].object;
      INTERSECTED.material.emissive = new THREE.Color(0x444444);
    }
  } else {
    if(INTERSECTED){
      INTERSECTED.material.emissive = new THREE.Color(0x000000);
      INTERSECTED = null;
    }
  }

  currentControls.update?.();
  renderer.render(scene, camera);
}
</script>
</body>
</html>
